name: ci

on: [ push ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        database: [ "h2", "postgresql", "mysql", "mariadb" ]

    steps:
      # Checkout
      - name: Configure git to checkout as-is
        run: git config --global core.autocrlf false

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: "21"
          distribution: "graalvm"
          cache: "maven"

      # Build & Test
      - name: Build with Maven
        run: mvn --batch-mode --no-transfer-progress install -Pnative -P${{ matrix.database }}

      # Upload artifacts
      - name: Upload cross-platform app
        uses: actions/upload-artifact@v4
        with:
          name: commafeed-${{ matrix.database }}-jvm
          path: commafeed-server/target/commafeed-*.zip

      - name: Upload native executable
        uses: actions/upload-artifact@v4
        with:
          name: commafeed-${{ matrix.database }}-${{ runner.os }}-${{ runner.arch }}
          path: commafeed-server/target/commafeed-*-runner

      # Docker
      - name: Login to Container Registry
        uses: docker/login-action@v3
        if: ${{ github.ref_type == 'tag' || github.ref_name == 'master' }}
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      ## tags
      - name: Docker build and push tag - native
        uses: docker/build-push-action@v6
        if: ${{ github.ref_type == 'tag' }}
        with:
          context: commafeed-server
          file: src/main/docker/Dockerfile.native
          push: true
          platforms: linux/amd64
          tags: |
            athou/commafeed:latest-native
            athou/commafeed:${{ github.ref_name }}-native

      - name: Docker build and push tag - jvm
        uses: docker/build-push-action@v6
        if: ${{ github.ref_type == 'tag' }}
        with:
          context: commafeed-server
          file: src/main/docker/Dockerfile.jvm
          push: true
          platforms: linux/arm64/v8
          tags: |
            athou/commafeed:latest-jvm
            athou/commafeed:${{ github.ref_name }}-jvm

      - name: Docker merge tag manifests
        uses: Noelware/docker-manifest-action@0.4.2
        if: ${{ github.ref_type == 'tag' }}
        with:
          inputs: athou/commafeed:latest
          images: athou/commafeed:latest-native,athou/commafeed:latest-jvm
          push: true

      ## master
      - name: Docker build and push master - native
        uses: docker/build-push-action@v6
        if: ${{ github.ref_name == 'master' }}
        with:
          context: commafeed-server
          file: src/main/docker/Dockerfile.native
          push: true
          platforms: linux/amd64
          tags: athou/commafeed:master-native

      - name: Docker build and push master - jvm
        uses: docker/build-push-action@v6
        if: ${{ github.ref_name == 'master' }}
        with:
          context: commafeed-server
          file: src/main/docker/Dockerfile.jvm
          push: true
          platforms: linux/arm64/v8
          tags: athou/commafeed:master-jvm

      - name: Docker merge master manifests
        uses: Noelware/docker-manifest-action@0.4.2
        if: ${{ github.ref_name == 'master' }}
        with:
          inputs: athou/commafeed:master
          images: athou/commafeed:master-native,athou/commafeed:master-jvm
          push: true
